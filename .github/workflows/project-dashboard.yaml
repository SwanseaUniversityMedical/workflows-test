name: Project Dashboard

on:
  pull_request:
    paths:
      - '.github/workflows/project-dashboard.yaml'
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  get-board:
    runs-on:
      labels: [ self-hosted, linux, x64 ]
      group: heavy
    steps:
        - uses: octokit/graphql-action@v2.x
          id: get_board
          with:
            query: |
              query {
                organization(login: "SwanseaUniversityMedical") {
                  projectV2(number: 15) {
                    id
                  }
                }
              }
          env:
            GITHUB_TOKEN: ${{ secrets.DASHBOARD_TEST_TOKEN }}
        - run: "echo 'latest release: ${{ steps.get_board.outputs.data }}'"
  add-issues:
    needs: get-board
    runs-on:
      labels: [ self-hosted, linux, x64 ]
      group: heavy
    steps:
      - uses: actions/github-script@v7
        id: my-script
        with:
          result-encoding: string
          retries: 3
          retry-exempt-status-codes: 400,401
          script: |
            import { Octokit } from "octokit";

            const octokit = new Octokit({ 
              auth: ${{ secrets.DASHBOARD_TEST_TOKEN }},
            });

  add-prs:
    needs: get-board
    runs-on:
      labels: [ self-hosted, linux, x64 ]
      group: heavy
    steps:
      - uses: actions/github-script@v7
        id: my-script
        with:
          result-encoding: string
          retries: 3
          retry-exempt-status-codes: 400,401
          script: |
            import { Octokit } from "octokit";

            const octokit = new Octokit({ 
              auth: ${{ secrets.DASHBOARD_TEST_TOKEN }},
            });